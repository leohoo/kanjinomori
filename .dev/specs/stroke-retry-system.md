# 書き問題リトライシステム仕様書

## 概要
初心者向けに、書き問題で間違えた場合にリトライ機会を与え、失敗理由のフィードバックと段階的なガイダンスを提供する。

---

## リトライフロー

| 試行 | 失敗時の動作 | 成功時のコイン |
|------|-------------|---------------|
| 1回目 | 「もう一度」（ヒントなし） | 5コイン |
| 2回目 | 失敗理由に応じたヒント表示 | 3コイン |
| 3回目 | トレースモード（なぞり書き） | 1コイン |

---

## 失敗理由の判定

### 判定タイプ
1. **画数エラー (`stroke_count`)**
   - ユーザーの画数とテンプレートの画数の差が許容範囲を超えた場合
   - ヒント例: 「画数を確認しよう」

2. **書き順エラー (`stroke_order`)**
   - 画数は合っているが、順番が違う場合
   - 判定方法: ストロークを並べ替えて再マッチングし、スコアが改善するか確認
   - ヒント例: 「書き順を確認しよう」

3. **形状エラー (`stroke_shape`)**
   - 画数・順番は合っているが、形が違う場合
   - ヒント例: 「形を確認しよう」

### 判定優先順位
1. 画数チェック（最初に判定）
2. 書き順チェック（画数が合っている場合）
3. 形状チェック（上記が合っている場合）

---

## トレースモード（3回目）

### 動作仕様
1. 画面に正しい漢字のストロークを1画ずつアニメーション表示
2. 各ストロークに沿って移動するガイドポイント（光る点）を表示
3. ユーザーはガイドポイントに沿ってなぞり書きする
4. 現在のストロークが十分に近い場合、自動的に次のストロークに進む
5. 全ストローク完了で成功（1コイン獲得）

### UI要素
- ガイドポイント: 光る円形のインジケーター
- ストロークパス: 薄く表示された正解の軌跡
- 進捗表示: 現在のストローク番号 / 全ストローク数

### 判定基準
- トレースモードでは判定を緩くする（distanceThreshold を上げる）
- ストロークの開始点がガイドポイント付近であること

---

## 実装箇所

### 1. StrokeGrader の拡張
- `gradeWithStrokes()` → `GradeResult` を返すように変更
- `GradeResult`: `passed`, `failureReason`, `distance` を含む

### 2. ゲーム状態の拡張
- `StageProgress` または `QuestionState` に `attemptCount` を追加
- 各問題ごとに試行回数を追跡

### 3. 新規ウィジェット
- `TraceAlongOverlay`: なぞり書きガイドのオーバーレイ
- `StrokeHintBanner`: 失敗理由のヒント表示

### 4. QuestionScreen の更新
- リトライフローの制御
- 試行回数に応じたUI切り替え
- コイン報酬の調整

---

## コイン報酬まとめ

| 状況 | コイン |
|------|--------|
| 1回目で正解 | 5 |
| 2回目で正解 | 3 |
| 3回目（トレース）で正解 | 1 |
| 3回目でも失敗 | 0（次の問題へ進む） |

---

## 将来の拡張案
- 書き順アニメーションの再生ボタン（ヒントとして任意で見られる）
- 失敗理由の統計表示（どのタイプのミスが多いか）
- 練習モード（コインなし、何度でもリトライ可能）
