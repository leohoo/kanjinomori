# Task 002: 2.5D Style Implementation

## Overview

Transform the game from flat 2D UI to a hybrid 2.5D style with:
- **Isometric view** for field exploration
- **Side-scrolling view** for real-time action battles

Reference spec: `.dev/specs/style-change-to-2.5d.md`

## Design Decisions (from feasibility review)

| Aspect | Decision |
|--------|----------|
| Game Engine | Flame (Flutter game engine) |
| Exploration View | Isometric, scrolling field |
| Battle View | Side-scrolling, real-time action |
| Door Selection | Free choice (any order) |
| Progression | 10 doors → 1 boss battle |
| Art Assets | Free asset stores (itch.io, Kenney, OpenGameArt) |

## Architecture

```
┌────────────────────────────────────────────────────────────┐
│                     GAME FLOW                              │
├────────────────────────────────────────────────────────────┤
│                                                            │
│   [Home] → [Stage Select] → [Field: Isometric]             │
│      │                           │                         │
│      │                      Walk to door                   │
│      ↓                           ↓                         │
│   [Shop]                  [Question Screen]                │
│                            (Pure Flutter)                  │
│                                  │                         │
│                            All 10 doors done               │
│                                  ↓                         │
│                         [Battle: Side-Scroll]              │
│                          Real-time action                  │
│                                  ↓                         │
│                           [Result Screen]                  │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

### Screen/Engine Mapping

| Screen | View Type | Engine | Controls |
|--------|-----------|--------|----------|
| HomeScreen | 2D UI | Flutter | Buttons |
| StageSelectScreen | 2D UI | Flutter | Buttons |
| FieldScreen (NEW) | Isometric | Flame | Joystick (8-dir) |
| QuestionScreen | 2D UI | Flutter | Buttons, Drawing |
| BattleScreen | Side-scroll | Flame | Joystick + Jump + Attack + Shield |
| ResultScreen | 2D UI | Flutter | Buttons |
| ShopScreen | 2D UI | Flutter | Buttons |

---

## Implementation Phases

### Phase 1: Foundation Setup

#### 1.1 Add Flame Dependencies
```yaml
# pubspec.yaml additions
dependencies:
  flame: ^1.18.0
  flame_audio: ^2.10.0  # Optional: for game audio
```

#### 1.2 Create Base Game Classes
- `lib/games/base_game.dart` - Shared game configuration
- `lib/games/components/` - Reusable game components

#### 1.3 Asset Sourcing
Source and organize assets:
```
assets/
├── sprites/
│   ├── player/
│   │   ├── idle.png
│   │   ├── walk.png
│   │   ├── jump.png
│   │   └── attack.png
│   ├── enemies/
│   │   └── boss_*.png
│   └── effects/
│       ├── wind.png
│       ├── dust.png
│       └── coins.png
├── tiles/
│   ├── forest_ground.png
│   ├── forest_trees.png
│   └── forest_door.png
└── ui/
    ├── joystick_bg.png
    ├── joystick_knob.png
    └── buttons/
```

**Recommended Asset Sources:**
- Kenney.nl - Free isometric tiles, UI elements
- itch.io - Character sprites, effects
- OpenGameArt.org - Various game assets

---

### Phase 2: Isometric Field Exploration

#### 2.1 Create FieldGame Class
Location: `lib/games/field_game.dart`

Components:
- `FieldGame extends FlameGame` - Main game class
- `IsometricTileMap` - Forest floor rendering
- `PlayerComponent` - Player character with 8-dir movement
- `DoorComponent` - 10 forest doors with collision
- `CameraComponent` - Follow player, scroll field

#### 2.2 Joystick Controls
- Position: Bottom-left
- Dead zone: 20%
- 8-directional movement mapping
- Dust effect at max input

#### 2.3 Door Interaction System
- Collision detection with doors
- Door states: `locked`, `available`, `completed`
- Visual feedback: glow effect on available doors
- Interaction trigger → Navigate to QuestionScreen

#### 2.4 Field Layout
- Scrollable forest area
- 10 doors distributed across the map
- Trees, decorations for atmosphere
- Minimap (optional)

#### 2.5 Integration with Flutter
- `GameWidget` embedded in Flutter screen
- Pass stage data to game
- Callback on door interaction
- Return to Flutter for questions

---

### Phase 3: Side-Scrolling Battle System

#### 3.1 Create BattleGame Class
Location: `lib/games/battle_game.dart`

Components:
- `BattleGame extends FlameGame` - Main battle game
- `BattlePlayer` - Player with jump, attack, shield
- `BattleEnemy` - Boss with AI behavior
- `BattleHUD` - HP bars, coin display
- `BattleControls` - Joystick + action buttons

#### 3.2 Player Mechanics

**Movement:**
- Left/Right via joystick
- Ground friction and acceleration

**Jump:**
- Tap: Normal jump
- Hold: Higher jump (up to 0.5s hold time)
- Gravity: Configurable fall speed
- Jump effect: White wind lines (0.35s duration)
- Landing effect: Small dust puff

**Attack:**
- Ground attack: Full damage
- Aerial attack: 80% damage, shorter recovery
- Critical chance: +5% when attacking from height
- Attack animation + hitbox timing

**Shield:**
- Block incoming damage
- Shield duration limit
- Cooldown between shields

#### 3.3 Enemy AI

**State Machine:**
```
States: IDLE → APPROACH → ATTACK → RETREAT → JUMP_ATTACK
```

**Behaviors:**
- Track player position
- Jump when player jumps (reactive)
- Mix of ground and aerial attacks
- Attack telegraphing (visual warning)
- Difficulty scaling per stage

#### 3.4 Battle Controls Layout
```
┌─────────────────────────────────────┐
│                           [Shield]  │  ← Right-top (medium)
│                                     │
│                           [Attack]  │  ← Right-middle (large)
│                                     │
│  [Joystick]               [Jump]    │  ← Bottom (medium)
└─────────────────────────────────────┘
```

#### 3.5 Combat System

**Damage Calculation:**
```dart
baseDamage = playerAttack + weaponBonus
kanjiBonus = (correctAnswers / totalQuestions > 0.5) ? 1.5 : 1.0
critMultiplier = (isAerial && random < 0.05 + heightBonus) ? 1.5 : 1.0
finalDamage = baseDamage * kanjiBonus * critMultiplier * (isAerial ? 0.8 : 1.0)
```

**Hit Detection:**
- Hitbox/Hurtbox system
- Invincibility frames after hit
- Knockback on damage

---

### Phase 4: Effects and Polish

#### 4.1 Particle Effects
- Jump wind lines (white, 0.35s)
- Landing dust cloud
- Attack slash effect
- Door completion (green glow + wind)
- Coin collection animation

#### 4.2 Screen Transitions
- Field → Question: Door opens animation
- Question → Field: Return to door position
- Field → Battle: All doors dissolve, teleport effect
- Battle → Result: Victory/defeat animation

#### 4.3 Audio (Optional)
- Movement footsteps
- Jump whoosh
- Attack sounds
- Door interaction chime
- Battle music
- Victory/defeat jingles

---

### Phase 5: Integration and Flow

#### 5.1 Update Navigation
Modify `lib/providers/game_provider.dart`:
- Add `FIELD` screen state
- Handle field → question → field flow
- Track door completion status

#### 5.2 Stage Data Updates
Modify `lib/models/stage.dart`:
- Door positions for each stage
- Door-to-question mapping
- Completion tracking per door

#### 5.3 Coin System Updates
Per spec:
- Each correct answer: +5 coins
- All 10 correct: +10 bonus
- Maximum per stage: 60 coins

#### 5.4 State Persistence
- Save door completion status
- Save field position on exit
- Resume capability

---

## File Structure (New/Modified)

### New Files
```
lib/
├── games/
│   ├── field/
│   │   ├── field_game.dart
│   │   ├── components/
│   │   │   ├── player_component.dart
│   │   │   ├── door_component.dart
│   │   │   ├── tile_map_component.dart
│   │   │   └── field_hud.dart
│   │   └── field_screen.dart        # Flutter wrapper
│   │
│   └── battle/
│       ├── battle_game.dart
│       ├── components/
│       │   ├── battle_player.dart
│       │   ├── battle_enemy.dart
│       │   ├── battle_hud.dart
│       │   └── battle_controls.dart
│       ├── systems/
│       │   ├── physics_system.dart
│       │   ├── combat_system.dart
│       │   └── enemy_ai.dart
│       └── battle_screen.dart       # Flutter wrapper (replace existing)
│
├── components/
│   ├── joystick_component.dart
│   ├── action_button.dart
│   └── particle_effects.dart
│
└── utils/
    └── collision_utils.dart
```

### Modified Files
```
lib/
├── main.dart                    # Add Flame initialization
├── providers/
│   └── game_provider.dart       # Add FIELD state, door tracking
├── models/
│   ├── stage.dart               # Add door positions
│   └── player.dart              # Add door completion tracking
├── screens/
│   └── stage_screen.dart        # Replace with FieldScreen or redirect
└── utils/
    └── constants.dart           # Add game physics constants
```

---

## Technical Specifications

### Physics Constants
```dart
// Player movement
const double playerSpeed = 200.0;        // pixels/sec
const double playerAcceleration = 800.0;
const double playerFriction = 600.0;

// Jump physics
const double jumpForce = 400.0;          // initial velocity
const double maxJumpForce = 600.0;       // held jump
const double gravity = 980.0;            // pixels/sec²
const double maxFallSpeed = 800.0;

// Combat
const double attackDuration = 0.3;       // seconds
const double aerialAttackDuration = 0.25;
const double shieldDuration = 1.0;
const double invincibilityDuration = 0.5;
```

### Isometric Conversion
```dart
// World to screen coordinates
Vector2 worldToScreen(Vector2 world) {
  return Vector2(
    (world.x - world.y) * tileWidth / 2,
    (world.x + world.y) * tileHeight / 2,
  );
}

// Screen to world coordinates
Vector2 screenToWorld(Vector2 screen) {
  return Vector2(
    (screen.x / (tileWidth / 2) + screen.y / (tileHeight / 2)) / 2,
    (screen.y / (tileHeight / 2) - screen.x / (tileWidth / 2)) / 2,
  );
}
```

---

## Dependencies

```yaml
dependencies:
  flame: ^1.18.0
  flame_audio: ^2.10.0        # Optional

  # Existing
  flutter_riverpod: ^2.4.9
  hive_flutter: ^1.1.0
  audioplayers: ^5.2.1
  google_fonts: ^6.1.0
```

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Asset style mismatch | Medium | Medium | Source all assets from same pack/artist |
| Performance on low-end devices | Low | High | Profile early, optimize particle count |
| Complex Flame-Flutter integration | Medium | Medium | Keep clear boundaries between engines |
| Battle balancing | High | Medium | Extensive playtesting, tunable constants |
| Isometric collision accuracy | Medium | Low | Use simple rectangular hitboxes |

---

## Success Criteria

- [x] Player can explore isometric field with joystick
- [ ] 10 doors visible and interactive on scrolling field
- [x] Doors trigger question screens correctly
- [x] Side-scroll battle with jump, attack, shield working
- [x] Aerial attacks deal 80% damage with +5% crit
- [x] Enemy AI jumps and attacks appropriately
- [ ] Jump effects (wind lines) display correctly
- [x] Coin rewards match spec (+5 per question, +10 bonus)
- [ ] Smooth transitions between all screens
- [ ] Game runs at 60fps on target devices

---

## Estimated Scope

| Phase | Components | Status |
|-------|------------|--------|
| Phase 1: Foundation | Dependencies, base classes, asset sourcing | ✅ Complete |
| Phase 2: Field | Isometric map, player movement, doors, camera | ⚠️ Movement done, tile rendering pending |
| Phase 3: Battle | Combat system, enemy AI, controls | ✅ Complete |
| Phase 4: Polish | Effects, transitions, audio | ⚠️ Code done, sprites missing |
| Phase 5: Integration | Navigation, state management, persistence | ✅ Complete |
| Phase 6: Assets | Download sprites, integrate visuals | ⚠️ Partial (player, enemy, door, UI sprites added) |
| Phase 7: Isometric | Convert field to isometric view | ⚠️ In progress (movement done, rendering pending) |

---

## Implementation Progress

### Completed (Phases 1-5 Code)
- [x] Flame engine integration
- [x] Physics constants (`GamePhysics` class)
- [x] FieldGame with PlayerComponent, DoorComponent, TileMapComponent
- [x] BattleGame with BattlePlayer, BattleEnemy, CombatSystem
- [x] Joystick + action button controls
- [x] Enemy AI state machine (idle, approach, attack, retreat, jump)
- [x] Particle effect classes (JumpWindEffect, LandingDustEffect, etc.)
- [x] Screen transition classes
- [x] GameCoordinator for door/question/battle flow
- [x] QuestionPanel widget with なぞり書き support
- [x] Navigation updates (GameScreen.field state)
- [x] Coin rewards (+5 per correct, +10 bonus)

### Remaining Work

#### Phase 6: Asset Integration
Download and integrate free sprites:

**Character Sprites:**
- [x] Player: run, jump animations (runner_spritesheet.png from Bevouliin, CC0)
- [x] Enemy/Boss: slime with idle, walk, attack, death (slime_spritesheet.png from Calciumtrice, CC-BY 3.0)

**Environment:**
- [x] Door sprite: portal with arch frame (portal1.png from Cethiel, CC0)
- [ ] Forest tiles (grass, trees, decorations) - not yet added

**UI Controls:**
- [x] Action buttons: jump, attack, shield (Kenney Mobile Controls, CC0)
- [ ] Joystick base and knob - using programmatic rendering

**Effects:**
- [ ] Wind lines (for jump) - using programmatic rendering
- [ ] Dust particles (for landing/running) - using programmatic rendering
- [ ] Glow effects (for doors) - using programmatic rendering

#### Phase 7: Isometric Conversion
- [x] Update PlayerComponent movement for isometric (joystick → diamond grid axes)
- [x] Update sprite facing based on screen velocity
- [ ] Implement `worldToScreen` / `screenToWorld` for tile positions
- [ ] Update TileMapComponent for isometric (diamond) rendering
- [ ] Update camera follow for isometric bounds
- [ ] Add depth sorting for sprites

---

## Notes

- Keep existing QuestionScreen (Flutter) - no changes needed
- Battle system is complete rewrite (turn-based → real-time)
- Consider keeping old battle as fallback/option
- Test on both iOS and Android early
- All game characters currently render as colored rectangles (placeholder)
